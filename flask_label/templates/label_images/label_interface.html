{% extends 'layout.html' %}

{% block header %}
  <h1>{% block title %}Label Interface{% endblock %}</h1>
{% endblock %}

{% block content %}
    <h2>Label Image {{ img_task['id'] }}: {{ img_task['filename'] }}</h2>
    <a href="{{ url_for('label_images.label_batch_overview', batch_id=batch_id) }}">Back</a>
    <a href="{{ url_for('label_images.next_task', batch_id=batch_id) }}">Next</a>
    <p>Link to image: {{ url_for('api.serve_image', img_id=img_task['id']) }}</p>
    <p>
        <img src="{{ url_for('api.serve_image', img_id=img_task['id']) }}" alt="Image to Label"/>
    </p>
    <a href="{{ url_for('label_images.label_batch_overview', batch_id=batch_id) }}">Back</a>
{% endblock %}

<!-- <!DOCTYPE html>
<html>

<head>
    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.css" rel="stylesheet" />
    <script type='text/javascript' src='https://s3.amazonaws.com/mturk-public/externalHIT_v1.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.js"></script>
</head>

<body>
    <div style="display:none;">&nbsp;</div>
    <div style="display:inline-block;vertical-align:top;">
        <h1>Create boxes around all instances of "{object_to_find}".</h1>
        <h4>Make sure to read the instructions at least once!</h4>
        <button id="instruction-toggle" style="margin-bottom:15px; display:block;" type="button">Toggle Instructions</button>
        <div id="instructions" style="display:none; overflow:hidden;">
            <h4>Instructions:</h4>
            <p>We use "Extreme Clicking" for drawing boxes. Extreme Clicking is a recently proposed framework.
                Extreme Clicking improves annotation speed and reduces errors.
                A box is created after 4 clicks at the extreme points. Extreme points are simply
                the most left, right, top and bottom points of an object.
                Ordering of the points does not matter. Substitute mouse clicks with hotkeys (see below) for more speed.</p>
            <p>The dataset contains raw and grilled burger patties. You are responsible for identifying only
                instances of {object_to_find}. Make sure to judge objects on their
                appearance only. Ignore the surroundings (e.g. a burger patty that is on a
                grill can be raw or grilled). If there is no object of the searched type, simply submit.</p>
            <h4>Hotkeys:</h4>
            <ul>
                <li>e = create point under mouse</li>
                <li>r = undo last point</li>
                <li>space = abort/undo last box</li>
            </ul>
            <p>If there are any questions or problems please contact us: mturk-support@gastrobotics.com</p>
        </div>
        <div id="bbox_annotator" style="display:inline-block"></div>

        <form id="button_paragraph" method="post" action="{external_submit}">
            <button id="reset_button" type="button">Reset</button>
            <input type='hidden' value='' name='assignmentId' id='assignmentId'/>
            <input id="annotation_data" name="annotation_data" type="hidden" />
            <input id="timing" name="timing" type="hidden" />
            <input type='submit' id='submitButton' value='Submit' />
        </form>
    </div>

    <script type="text/javascript">
        (function () {
            var BBoxSelector;

            BBoxSelector = (function () {

                function BBoxSelector(image_frame, options) {
                    if (options == null) {
                        options = {};
                    }
                    options.input_method || (options.input_method = "text");
                    this.image_frame = image_frame;
                    this.border_width = options.border_width || 2;
                    this.selector = $('<div class="bbox_selector"></div>');
                    this.selector.css({
                        "border": "none",
                        "position": "absolute"
                    });
                    this.image_frame.append(this.selector);
                    this.selector.css({
                        "border-width": this.border_width
                    });
                    this.fixed_label = options.labels[0].slice();
                    this.create_label_box(options);
                    this.pts_x = [];
                    this.pts_y = [];
                    this.pts_x_history = [];
                    this.pts_y_history = [];
                }

                BBoxSelector.prototype.create_label_box = function(options) {
                      var label, _i, _len, _ref;
                      options.labels || (options.labels = ["object"]);
                      this.label_box = $('<div class="label_box"></div>');
                      this.label_box.css({
                        "position": "absolute"
                      });
                      this.label_box.css({
                        "z-index": "1000"
                      });

                      this.image_frame.append(this.label_box);
                      this.input_method = options.input_method;
                      switch (options.input_method) {
                        case 'select':
                          if (typeof options.labels === "string") {
                            options.labels = [options.labels];
                          }
                          this.label_input = $('<select class="label_input" name="label"></select>');
                          this.label_box.append(this.label_input);
                          this.label_input.append($('<option value>choose an item</option>'));
                          _ref = options.labels;
                          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                            label = _ref[_i];
                            this.label_input.append('<option value="' + label + '">' + label + '</option>');
                          }
                          this.label_input.change(function(e) {
                            return this.blur();
                          });
                          break;
                        case 'text':
                          if (typeof options.labels === "string") {
                            options.labels = [options.labels];
                          }
                          this.label_input = $('<input class="label_input" name="label" ' + 'type="text" value>');
                          this.label_box.append(this.label_input);
                          this.label_input.autocomplete({
                            source: options.labels || [''],
                            autoFocus: true
                          });
                          break;
                        case 'fixed':
                          if ($.isArray(options.labels)) {
                            options.labels = options.labels[0];
                          }
                          this.label_input = $('<input class="label_input" name="label" type="text">');
                          this.label_box.append(this.label_input);
                          this.label_input.val(options.labels);
                          break;
                        default:
                          throw 'Invalid label_input parameter: ' + options.input_method;
                      }
                      return this.label_box.hide();
                    };

                BBoxSelector.prototype.add_pt = function (pageX, pageY) {
                    x = Math.min(Math.max(Math.round(pageX - this.image_frame.offset().left), 0), Math.round(this.image_frame.width() - 1)),
                    y = Math.min(Math.max(Math.round(pageY - this.image_frame.offset().top), 0), Math.round(this.image_frame.height() - 1))
                    this.pts_x.push(x);
                    this.pts_y.push(y);
                    this.add_pt_graphics(x, y);
                };

                BBoxSelector.prototype.add_pt_graphics = function (x, y){
                    $("<div ></div>").appendTo(this.selector).css({
                        "position": "absolute",
                        "top": (y - 6) + "px",
                        "left": (x - 6) + "px",
                        "width": "10px",
                        "height": "10px",
                        "overflow": "hidden",
                        "color": "#fff",
                        "background-color": "rgba(0,0.5,0,0.5)",
                        "border": "2px solid #0c0",
                        "-moz-border-radius": "10px",
                        "-webkit-border-radius": "10px",
                        "border-radius": "10px",
                    });
                };

                BBoxSelector.prototype.pop_pt_graphics = function (){
                    pt = this.selector.children().last();
                    pt.detach();
                };

                BBoxSelector.prototype.clear_pt_graphics = function (){
                    this.selector.empty();
                };

                BBoxSelector.prototype.has_enough_pts = function () {
                    if (this.pts_x.length == 4 && this.pts_y.length == 4) {
                        return true;
                    }
                    return false;
                };

                BBoxSelector.prototype.input_label = function (options) {
                    $('body').css('cursor', 'default');
                    document.onselectstart = function () {
                        return true;
                    };
                    this.label_box.show();
                    return this.label_input.focus();
                };

                BBoxSelector.prototype.finish = function (options) {
                    var data;
                    this.label_box.hide();
                    data = this.rectangle();
                    data.label = $.trim(this.label_input.val().toLowerCase());
                    if (options.input_method !== 'fixed') {
                        this.label_input.val('');
                    }
                    this.pts_x_history.push(this.pts_x);
                    this.pts_y_history.push(this.pts_y);
                    this.pts_x = [];
                    this.pts_y = [];
                    this.clear_pt_graphics();
                    return data;
                };

                BBoxSelector.prototype.rectangle = function () {
                    var rect, minX, maxX, minY, maxY;
                    minX = Math.min.apply(null, this.pts_x);
                    maxX = Math.max.apply(null, this.pts_x);
                    minY = Math.min.apply(null, this.pts_y);
                    maxY = Math.max.apply(null, this.pts_y);
                    rect = {
                        left: minX,
                        top: minY,
                        width: maxX - minX,
                        height: maxY - minY
                    };
                    return rect;
                };

                BBoxSelector.prototype.reset_values = function() {
                    this.pts_x = [];
                    this.pts_y = [];
                    this.label_box.hide();
                    if (this.input_method !== 'fixed') {
                        this.label_input.val('');
                    }
                    if (this.input_method === 'fixed') {
                        this.label_input.val(this.fixed_label);
                    }
                    this.clear_pt_graphics();
                };

                BBoxSelector.prototype.undo_last = function () {
                    if (this.pts_x.length > 0) {
                        this.pts_x.splice(-1, 1);
                        this.pts_y.splice(-1, 1);
                        this.label_box.hide();
                        this.pop_pt_graphics();
                        if (this.input_method !== 'fixed') {
                            this.label_input.val('');
                        }
                    }
                };

                BBoxSelector.prototype.clear_history = function () {
                    this.pts_x_history = [];
                    this.pts_y_history = [];
                };

                BBoxSelector.prototype.pop_history = function () {
                    // Moves the history back once, puts the data back into pts
                    this.pts_x = this.pts_x_history.splice(-1, 1)[0];
                    this.pts_y = this.pts_y_history.splice(-1, 1)[0];
                    for (var i = 0; i < this.pts_x.length; ++i) {
                        this.add_pt_graphics(this.pts_x[i], this.pts_y[i]);
                    }
                };

                BBoxSelector.prototype.rewind_history = function () {
                    // Moves the history back once, removes the data pts
                    this.pts_x_history.splice(-1, 1)[0];
                    this.pts_y_history.splice(-1, 1)[0];
                };

                BBoxSelector.prototype.get_input_element = function () {
                    return this.label_input;
                };

                return BBoxSelector;

            })();

            this.BBoxAnnotator = (function () {

                function BBoxAnnotator(options) {
                    var annotator, image_element;
                    annotator = this;
                    this.annotator_element = $(options.id || "#bbox_annotator");
                    this.border_width = options.border_width || 2;
                    this.show_label = options.show_label || (options.input_method !== "fixed");
                    this.image_frame = $('<div class="image_frame"></div>');
                    this.annotator_element.append(this.image_frame);
                    image_element = new Image();
                    image_element.src = options.url;
                    image_element.onload = function () {
                        options.width || (options.width = image_element.width);
                        options.height || (options.height = image_element.height);
                        annotator.annotator_element.css({
                            "width": (options.width + annotator.border_width * 2) + 'px',
                            "height": (options.height + annotator.border_width * 2) + 'px',
                            "cursor": "crosshair",
                            "padding": "50px",
                            "padding-left": "100px"
                        });
                        annotator.image_frame.css({
                            "background-image": "url('" + image_element.src + "')",
                            "width": options.width + "px",
                            "height": options.height + "px",
                            "position": "relative"
                        });
                        annotator.selector = new BBoxSelector(annotator.image_frame, options);
                        return annotator.initialize_events(annotator.selector, options);
                    };
                    image_element.onerror = function () {
                        return annotator.annotator_element.text("Invalid image URL: " + options.url);
                    };
                    this.entries = [];
                    this.onchange = options.onchange;
                    this.mouse_x = 0;
                    this.mouse_y = 0;
                    this.status ='free';
                }

                BBoxAnnotator.prototype.initialize_events = function (selector, options) {
                    var annotator;
                    this.hit_menuitem = false;
                    annotator = this;
                    this.annotator_element.click(function (e) {
                        if (!annotator.hit_menuitem) {
                            switch (annotator.status) {
                                case 'free':
                                case 'boxing':
                                case 'input':
                                    if (annotator.status === 'input') {
                                        selector.get_input_element().blur();
                                    }
                                    if (e.which === 1) {
                                        selector.add_pt(e.pageX, e.pageY);
                                        if (selector.has_enough_pts()) {
                                            selector.input_label(options);
                                            annotator.status = 'input'
                                            if (options.input_method === 'fixed') {
                                                selector.get_input_element().blur();
                                            }
                                        }
                                        else {
                                            annotator.status = 'boxing'
                                        }
                                    }
                            }
                        }
                        annotator.hit_menuitem = false;
                        return true;
                    });
                    $(document).keydown(function(e) {
                        if (annotator.status !== 'input' && e.key === "e") {
                            var ne = new jQuery.Event("click");
                            ne.which = 1;
                            ne.pageX = annotator.mouse_x;
                            ne.pageY = annotator.mouse_y;
                            annotator.annotator_element.trigger(ne);
                        }
                        else if (e.key === "r") {
                            annotator.undo_last_pt();
                        }
                        else if (e.key === "u") {
                            annotator.undo_box();
                        }
                        return true;
                    });
                    $(document).mousemove(function(e) {
                        annotator.mouse_x = e.pageX;
                        annotator.mouse_y = e.pageY;
                        return true;
                    });
                    selector.get_input_element().blur(function (e) {
                        // This method is called to call to insert an element
                        var data;
                        switch (annotator.status) {
                            case 'input':
                                data = selector.finish(options);
                                if (data.label) {
                                    annotator.add_entry(data);
                                    if (annotator.onchange) {
                                        annotator.onchange(annotator.entries);
                                    }
                                }
                                annotator.status = 'free';
                        }
                        return true;
                    });
                    selector.get_input_element().keypress(function (e) {
                        switch (annotator.status) {
                            case 'input':
                                if (e.which === 13) {
                                    selector.get_input_element().blur();
                                }
                        }
                        return e.which !== 13;
                    });
                    selector.get_input_element().mousedown(function (e) {
                        return annotator.hit_menuitem = true;
                    });
                    selector.get_input_element().mousemove(function (e) {
                        return annotator.hit_menuitem = true;
                    });
                    selector.get_input_element().mouseup(function (e) {
                        return annotator.hit_menuitem = true;
                    });
                    return selector.get_input_element().parent().mousedown(function (e) {
                        return annotator.hit_menuitem = true;
                    });
                };

                BBoxAnnotator.prototype.add_entry = function (entry) {
                    var annotator, box_element, close_button, text_box;
                    this.entries.push(entry);
                    box_element = $('<div class="annotated_bounding_box"></div>');
                    box_element.appendTo(this.image_frame).css({
                        "border": this.border_width + "px solid rgb(127,255,127)",
                        "position": "absolute",
                        "top": (entry.top - this.border_width) + "px",
                        "left": (entry.left - this.border_width) + "px",
                        "width": entry.width + "px",
                        "height": entry.height + "px",
                        "color": "rgb(127,255,127)",
                        "font-family": "monospace",
                        "font-size": "small"
                    });
                    close_button = $('<div></div>').appendTo(box_element).css({
                        "position": "absolute",
                        "top": "-8px",
                        "right": "-8px",
                        "width": "16px",
                        "height": "0",
                        "padding": "16px 0 0 0",
                        "overflow": "hidden",
                        "color": "#fff",
                        "background-color": "#030",
                        "border": "2px solid #fff",
                        "-moz-border-radius": "18px",
                        "-webkit-border-radius": "18px",
                        "border-radius": "18px",
                        "cursor": "pointer",
                        "-moz-user-select": "none",
                        "-webkit-user-select": "none",
                        "user-select": "none",
                        "text-align": "center"
                    });
                    $("<div></div>").appendTo(close_button).html('×').css({
                        "display": "block",
                        "text-align": "center",
                        "width": "16px",
                        "position": "absolute",
                        "top": "-2px",
                        "left": "0",
                        "font-size": "16px",
                        "line-height": "16px",
                        "font-family": '"Helvetica Neue", Consolas, Verdana, Tahoma, Calibri, ' + 'Helvetica, Menlo, "Droid Sans", sans-serif'
                    });
                    text_box = $('<div></div>').appendTo(box_element).css({
                        "overflow": "hidden"
                    });
                    if (this.show_label) {
                        text_box.text(entry.label);
                    }
                    annotator = this;
                    box_element.hover((function (e) {
                        return close_button.show();
                    }), (function (e) {
                        return close_button.hide();
                    }));
                    close_button.mousedown(function (e) {
                        return annotator.hit_menuitem = true;
                    });
                    close_button.click(function (e) {
                        var clicked_box, index;
                        clicked_box = close_button.parent(".annotated_bounding_box");
                        index = clicked_box.prevAll(".annotated_bounding_box").length;
                        clicked_box.detach();
                        annotator.entries.splice(index, 1);
                        return annotator.onchange(annotator.entries);
                    });
                    return close_button.hide();
                };

                BBoxAnnotator.prototype.clear_all = function (e) {
                    $(".annotated_bounding_box").detach();
                    this.entries.splice(0);
                    this.selector.reset_values();
                    this.selector.clear_history();
                    this.status = "free";
                    return this.onchange(this.entries);
                };

                BBoxAnnotator.prototype.undo_box = function (e) {
                    this.undo_fn(true);
                };

                BBoxAnnotator.prototype.undo_fn = function(rewind_history) {
                    switch (this.status) {
                        case 'free':
                            if (this.entries.length > 0) {
                                box = this.image_frame.children().last()
                                box.detach();
                                this.entries.splice(-1, 1);
                                if (rewind_history) {
                                    this.selector.rewind_history();
                                }
                                return this.onchange(this.entries);
                            }
                            break;
                        case 'boxing':
                        case 'input':
                            this.status = "free";
                            this.selector.reset_values();
                    }
                };

                BBoxAnnotator.prototype.undo_last_pt = function (e) {
                    switch (this.status) {
                        case 'free':
                            if (this.entries.length > 0) {
                                this.undo_fn(false);
                                this.selector.pop_history();
                                this.selector.undo_last();
                                this.status = "boxing";
                            }
                            break;
                        case 'boxing':
                        case 'input':
                            this.selector.undo_last();
                            if (this.selector.pts_x.length == 0)
                                this.status = "free";
                    }
                };

                return BBoxAnnotator;

            })();

        }).call(this);

        // Main entry point. Use a placeholder for image urls.
        $(document).ready(function () {
            console.log("version 1.0")
            var start = new Date().getTime(); // Get inaccurate timing (granularity is not important)
            var assignment_id = turkGetParam('assignmentId', "");
            //var assignment_id = "";
            // Initialize the bounding-box annotator.
            var annotator = new BBoxAnnotator({
                url: "{image_url}",
                input_method: 'fixed', // Can be one of ['text', 'select', 'fixed']
                labels: ["{label_name}"], // Label of the object.
                onchange: function (entries) {
                    $("#annotation_data").val(JSON.stringify(entries));
                    if (entries.length > 0 &&
                        assignment_id != "" &&
                        assignment_id != "ASSIGNMENT_ID_NOT_AVAILABLE") {
                        $("#submitButton").removeAttr("disabled");
                    }
                    else {
                        $("#submitButton").attr("disabled", "disabled");
                    }
                }
            });
            // Initialize the instructions toggle
            var instructions = $("#instructions");
            $("#instruction-toggle").click(function (e) {
                e.preventDefault();
                e.stopPropagation();
                if (instructions.css("display") === "none") {
                    instructions.css({
                        "display": "block"
                    })
                }
                else {
                    instructions.css({
                        "display": "none"
                    })
                }
                return true;
            });

            $("#assignmentId").val(assignment_id);

            // Initialize the reset button.
            $("#reset_button").click(function (e) {
                e.preventDefault();
                e.stopPropagation();
                annotator.clear_all();
            });
            // Disable the submission at the beginning.
            $("#submitButton").attr("disabled", "disabled");
            if (assignment_id == "ASSIGNMENT_ID_NOT_AVAILABLE") {
                $("#submitButton").val("This is preview");
            }
            $("#button_paragraph").submit(function(e) {
                e.preventDefault();
                var end = new Date().getTime();
                $("#timing").val((end - start).toString());
                this.submit();
            });
            console.log(assignment_id);
        });
    </script>
</body>

</html> -->